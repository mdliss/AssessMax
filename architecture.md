# Middle School Non-Academic Skills Measurement Engine â€” System Architecture

## Overview
Backend-first architecture using Python FastAPI with an NLP pipeline (Hugging Face + spaCy + NLTK). Storage split between RDS PostgreSQL for relational assessments and DynamoDB for job/artifact metadata. Files in S3. Asynchronous processing via AWS Lambda, SQS, and Step Functions. Educator dashboard via Streamlit. Authentication and RBAC via AWS Cognito. Observability via CloudWatch. Packaged in Docker and deployed with GitHub Actions.

## Architecture Diagram
```mermaid
graph TB
  subgraph Educator Devices
    UI[Streamlit Dashboard]
  end

  subgraph API Layer (FastAPI on EC2/Fargate)
    APIGW[API: /v1/*]
    AuthDep[JWT Verification\nCognito JWKS]
    RouterIngest[Ingest Router]
    RouterAssess[Assessments Router]
    RouterJobs[Jobs Router]
  end

  subgraph Async Processing
    SQS[SQS Queue]
    STEP[Step Functions\nState Machine]
    L1[Lambda: Normalize]
    L2[Lambda: Score]
    L3[Lambda: Aggregate/Publish]
  end

  subgraph Data Stores
    S3[S3: raw/ normalized/ outputs/]
    RDS[(RDS PostgreSQL\nassessments, evidence, aggregates)]
    DDB[(DynamoDB\njobs, artifacts)]
  end

  subgraph Security and Observability
    COG[Cognito User Pool]
    KMS[KMS Keys]
    CW[CloudWatch Logs and Metrics]
    SSM[SSM / Secrets Manager]
  end

  UI -->|OAuth| COG
  UI -->|HTTPS| APIGW
  APIGW --> AuthDep
  APIGW --> RouterIngest
  APIGW --> RouterAssess
  APIGW --> RouterJobs

  RouterIngest -->|presigned PUT| S3
  RouterIngest -->|create| DDB

  RouterJobs -->|enqueue| SQS
  SQS --> STEP
  STEP --> L1 --> S3
  L1 -->|write normalized| S3
  STEP --> L2 --> S3
  L2 -->|read normalized| S3
  L2 -->|write scores| S3
  STEP --> L3 --> RDS
  L3 -->|write aggregates| RDS
  RouterAssess -->|read| RDS
  RouterAssess -->|read job status| DDB

  COG --> AuthDep
  APIGW --> CW
  L1 --> CW
  L2 --> CW
  L3 --> CW
  S3 --> KMS
  RDS --> KMS
  DDB --> KMS
  APIGW --> SSM
```

## Components
1) FastAPI Service
- Endpoints: health, presigned upload, job trigger, assessments, evidence, class dashboards.
- Security: Cognito JWT verify middleware; RBAC from JWT groups.
- OpenAPI: autogenerated.

2) NLP Pipeline
- Stages: cleaning -> sentence splitting -> cue detection -> transformer classification -> calibration -> evidence selection.
- Libraries: Hugging Face, spaCy, NLTK.
- Determinism: fixed seeds; record model_version and config_hash.

3) Asynchronous Batch
- Pattern: Step Functions orchestration; Lambda tasks; SQS decoupling.
- Retries: exponential backoff; DLQ for poison messages.
- Idempotency: job tokens; S3 key conventions; DynamoDB conditional writes.

4) Storage
- S3: raw inputs, normalized JSONL, outputs; versioning and KMS encryption.
- RDS: relational schema for analytics, time series, and evidence joins.
- DynamoDB: job and artifact metadata; rapid lookups by job_id.

5) Dashboard (Streamlit)
- Pages: Class Overview, Student Detail, Trends, Uploads and Jobs.
- Auth: Cognito Hosted UI; tokens stored as secure cookies.
- Exports: CSV and PDF.

6) DevOps
- Docker: slim runtime images; non-root.
- CI/CD: GitHub Actions builds, tests, security scanning, deploy gates.
- Observability: CloudWatch dashboards and alarms.

## Data Schemas
PostgreSQL
CREATE TABLE students (
  student_id UUID PRIMARY KEY,
  class_id TEXT NOT NULL,
  name TEXT,
  external_ref TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE assessments (
  assessment_id UUID PRIMARY KEY,
  student_id UUID REFERENCES students(student_id),
  class_id TEXT NOT NULL,
  assessed_on DATE NOT NULL,
  model_version TEXT NOT NULL,
  empathy NUMERIC,
  adaptability NUMERIC,
  collaboration NUMERIC,
  communication NUMERIC,
  self_regulation NUMERIC,
  confidence_empathy NUMERIC,
  confidence_adaptability NUMERIC,
  confidence_collaboration NUMERIC,
  confidence_communication NUMERIC,
  confidence_self_regulation NUMERIC,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE evidence (
  evidence_id UUID PRIMARY KEY,
  assessment_id UUID REFERENCES assessments(assessment_id),
  skill TEXT NOT NULL,
  span_text TEXT NOT NULL,
  span_location TEXT NOT NULL,
  rationale TEXT NOT NULL,
  score_contrib NUMERIC,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE class_aggregates (
  class_id TEXT NOT NULL,
  window_start DATE NOT NULL,
  window_end DATE NOT NULL,
  metric_name TEXT NOT NULL,
  metric_value NUMERIC NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (class_id, window_start, window_end, metric_name)
);

DynamoDB (summary):
- jobs: job_id (PK), status, class_id, date, input_keys, output_keys, error, started_at, ended_at
- artifacts: artifact_key (PK), uploader_id, class_id, content_type, sha256, created_at

## Key Flows
A) Ingestion
1. Educator requests presigned URL.
2. Upload file to S3 raw/...
3. Create artifacts record.
4. Trigger job with class_id and date.

B) Normalization
1. Lambda reads raw inputs.
2. Parse to canonical JSONL.
3. Write to normalized/...
4. Update jobs to normalized.

C) Scoring
1. Lambda loads models.
2. Process transcripts and artifacts.
3. Produce scores and evidence; write to outputs/...
4. Update jobs to scored.

D) Aggregation/Publish
1. Lambda writes assessments/evidence into RDS.
2. Recompute class aggregates.
3. Update jobs to succeeded.

## Performance Targets
- p95 API latency < 250 ms for reads.
- Batch: 1 class-day end-to-end < 30 min baseline.
- Dashboard page load < 2 s for class of 30.
- Evidence span mapping accuracy >= 95%.

## Security
- Cognito-issued JWTs; group-based RBAC.
- S3, RDS, DDB encrypted with KMS.
- VPC endpoints for S3/DDB/RDS.
- CloudWatch audit logs for access to PII.

## Runbook (Abbreviated)
- Red job: check DLQ, review Lambda logs, requeue with same job_id.
- High latency: inspect p95 dashboard, scale out workers, throttle job intake.
- PII incident: rotate KMS keys if required, revoke tokens, export audit logs.

## Future Enhancements
- Predictive analytics of skill trajectories.
- LTI 1.3 integrations.
- Multilingual pipelines.
- Vector search for evidence retrieval augmentation.
- Advanced React dashboard with role-aware widgets.