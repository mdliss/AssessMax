version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: assessmax-postgres
    environment:
      POSTGRES_DB: assessmax
      POSTGRES_USER: assessmax_user
      POSTGRES_PASSWORD: dev_password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  localstack:
    image: localstack/localstack:2.3
    container_name: assessmax-localstack
    environment:
      SERVICES: s3,dynamodb,sqs,sts,iam
      DEFAULT_REGION: us-east-1
      EDGE_PORT: 4566
    ports:
      - "4566:4566"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"

  backend:
    build:
      context: ./backend
    container_name: assessmax-backend
    env_file:
      - backend/.env.compose
    depends_on:
      - postgres
      - localstack
    ports:
      - "8000:8000"
    command: ./start.sh

  dashboard:
    build:
      context: ./dashboard
    container_name: assessmax-dashboard
    environment:
      API_BASE_URL: http://backend:8000
    depends_on:
      - backend
    ports:
      - "8501:8501"
    command: streamlit run app.py --server.port 8501 --server.address 0.0.0.0

volumes:
  pgdata:
